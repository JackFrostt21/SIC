{% extends "admin/base_site.html" %}

{% block content_title %}Сводный отчёт по молниям и подразделениям{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 100%;">
    <style>
        /* Стили аналогичны lightnings_vs_users_statistics.html */
        .toolbar {
            display: flex; align-items: center; justify-content: space-between;
            gap: .75rem; flex-wrap: wrap; margin-bottom: .5rem;
        }
        .toolbar .left, .toolbar .right { display: flex; align-items: center; gap: .5rem; flex-wrap: wrap; }
        .btn { cursor: pointer; }
        .btn-sm { padding: .25rem .5rem; font-size: .875rem; border-radius: .5rem; }
        .btn-primary { background:#0d6efd; color:#fff; border:1px solid #0d6efd; }
        .btn-outline-secondary { background:#fff; color:#6c757d; border:1px solid #ced4da; }
        .btn-success { background:#198754; color:#fff; border:1px solid #198754; }
        .btn-light { background:#f8f9fa; color:#212529; border:1px solid #e9ecef; }
        
        /* Drawer */
        .drawer-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,.35);
            opacity:0; pointer-events:none; transition: opacity .2s ease;
            z-index: 1040;
        }
        .drawer-backdrop.show { opacity:1; pointer-events: all; }
        .drawer {
            position: fixed; top: 0; right: 0; height: 100%; width: 420px;
            max-width: 100vw; background: #fff; transform: translateX(100%);
            transition: transform .25s ease; box-shadow: -8px 0 24px rgba(0,0,0,.12);
            z-index: 1050; display: flex; flex-direction: column;
        }
        .drawer.open { transform: translateX(0); }
        .drawer-header {
            padding: .75rem 1rem; border-bottom: 1px solid #f0f0f0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .drawer-body { padding: 1rem; overflow-y: auto; }
        .drawer-footer {
            padding: .75rem 1rem; border-top: 1px solid #f0f0f0; display:flex; gap:.5rem; justify-content:flex-end;
        }
        
        /* Form */
        .filters-grid { display: grid; grid-template-columns: 1fr; gap: .75rem; }
        .form-label { display:block; margin-bottom: .25rem; font-size: .85rem; color:#6c757d; }
        .form-control, .form-select {
            width: 100%; border: 1px solid #ced4da; border-radius: .5rem;
            padding: .375rem .5rem; font-size: .9rem;
        }

        /* Table wrapper */
        .report-wrapper { 
            overflow: auto; 
            border: 1px solid #f0f0f0; 
            border-radius: .75rem; 
            /* Фиксируем высоту контейнера, чтобы он влезал в экран, и скроллбар был виден внизу */
            height: calc(100vh - 220px); 
            min-height: 400px;
        }
        /* min-width: max-content заставит таблицу быть шириной по содержимому, вызывая скролл */
        table.table { width: auto; min-width: 100%; border-collapse: separate; border-spacing: 0; }
        .table thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 3; border-bottom: 1px solid #e9ecef; vertical-align: middle; }
        .table th, .table td { 
            padding: .5rem .75rem; 
            border-bottom: 1px solid #f2f2f2; 
            border-right: 1px solid #f7f7f7; 
            text-align: center; 
            white-space: nowrap; /* Чтобы не переносилось и появлялся скролл */
        }
        .table td:first-child, .table th:first-child { 
            text-align: left; 
            white-space: normal; /* Название молнии может переноситься, но можно и nowrap */
            min-width: 200px;
            max-width: 400px;
        }
        
        /* Sticky First Col */
        .col-sticky {
            position: sticky; left: 0; z-index: 2; background: #fff;
            box-shadow: 2px 0 0 rgba(0,0,0,0.02);
            white-space: nowrap;
        }
        .thead-sticky-first { position: sticky; left: 0; z-index: 4; background: #f8f9fa; }
        
        .table tr:hover td, .table tr:hover th { background: #fcfcfd; }
        .table tr.total-row { font-weight: bold; background: #e9ecef; }
        .table tr.total-row td { background: #e9ecef; }
        
        .bg-highlight { background-color: #fff3cd; } /* Подсветка значений > 0 */
    </style>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="left">
            <strong>Количество сотрудников, не ознакомившихся с молнией</strong>
        </div>
        <div class="right">
            <button type="button" id="btn-open-filters" class="btn btn-sm btn-primary">
                Настройки
                {% if has_active_filters %}
                  <span title="Активны фильтры" style="margin-left:.4rem; font-size: .9em;">●</span>
                {% endif %}
            </button>
            <a class="btn btn-sm btn-success" href="?{% if base_query %}{{ base_query }}&{% endif %}export=xlsx">Экспорт XLSX</a>
            <a class="btn btn-sm btn-outline-secondary" href="?">Сброс</a>
        </div>
    </div>

    <div class="report-wrapper">
        <table class="table table-sm table-bordered">
            <thead>
                <tr>
                    <th class="thead-sticky-first" style="min-width: 250px;">Молнии</th>
                    <th style="min-width: 100px;">Дата отправления</th>
                    <th style="min-width: 80px; background: #e2e3e5;">Кол-во не ознакомленых</th>
                    {% for h in dept_headers %}
                        <th title="{{ h.name }}">{{ h.full_str }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr>
                    <th scope="row" class="col-sticky">{{ row.lightning.name }}</th>
                    <td>{{ row.lightning.created_at|date:"d.m.Y" }}</td>
                    <td style="background: #e2e3e5;">{{ row.total }}</td>
                    {% for val in row.values %}
                        <td {% if val > 0 %}class="bg-highlight"{% endif %}>
                            {{ val|default:"" }}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
                
                <!-- ИТОГО -->
                <tr class="total-row">
                    <td class="col-sticky">ИТОГО</td>
                    <td></td>
                    <td>{{ total_row.total }}</td>
                    {% for val in total_row.values %}
                        <td>
                            {{ val|default:"" }}
                        </td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>
    </div>
    
    {% if not rows %}
        <div class="alert alert-info mt-3">Нет данных для отображения.</div>
    {% endif %}

    <!-- Drawer Filters -->
    <div id="drawer-backdrop" class="drawer-backdrop"></div>
    <div id="filters-drawer" class="drawer" aria-hidden="true">
        <div class="drawer-header">
            <strong>Настройки отчёта</strong>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-close-filters">Закрыть</button>
        </div>
        <form method="get" class="drawer-body" id="filters-form">
            <div class="filters-grid">
                <div>
                    <label class="form-label">Молнии</label>
                    <select name="lightning_id" class="form-select" multiple>
                        {% for l in filter_lightnings %}
                            <option value="{{ l.id }}" {% if l.id|stringformat:'s' in selected_lightning_ids %}selected{% endif %}>[{{ l.id }}] {{ l.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Можно выбрать несколько (Ctrl/Shift).</div>
                </div>
                <div>
                    <label class="form-label">Подразделение (родители)</label>
                    <select name="department_id" class="form-select" multiple>
                      {% for d in departments %}
                        <option value="{{ d.id }}" {% if d.id|stringformat:'s' in selected_department_ids %}selected{% endif %}>
                          [{{ d.id }}] {{ d.name }}
                        </option>
                      {% endfor %}
                    </select>
                    <div class="form-text">Можно выбрать несколько (Ctrl/Shift).</div>
                </div>
                <div>
                    <label class="form-label">Локация</label>
                    <select name="location_id" class="form-select" multiple>
                      {% for loc in locations %}
                        <option value="{{ loc.id }}" {% if loc.id|stringformat:'s' in selected_location_ids %}selected{% endif %}>
                          [{{ loc.id }}] {{ loc.name }}
                        </option>
                      {% endfor %}
                    </select>
                    <div class="form-text">Если выбрано подразделение — локации игнорируются.</div>
                </div>
                <div>
                    <label class="form-label">Дата от</label>
                    <input type="date" name="date_from" value="{{ request.GET.date_from|default:'' }}" class="form-control">
                </div>
                <div>
                    <label class="form-label">Дата до</label>
                    <input type="date" name="date_to" value="{{ request.GET.date_to|default:'' }}" class="form-control">
                </div>
            </div>
        </form>
        <div class="drawer-footer">
            <a class="btn btn-sm btn-outline-secondary" href="?">Сброс</a>
            <button type="submit" form="filters-form" class="btn btn-sm btn-primary">Применить</button>
        </div>
    </div>

    <script>
        (function(){
            const openBtn = document.getElementById('btn-open-filters');
            const closeBtn = document.getElementById('btn-close-filters');
            const drawer = document.getElementById('filters-drawer');
            const backdrop = document.getElementById('drawer-backdrop');

            function openDrawer(){
                drawer.classList.add('open');
                backdrop.classList.add('show');
                drawer.setAttribute('aria-hidden', 'false');
            }
            function closeDrawer(){
                drawer.classList.remove('open');
                backdrop.classList.remove('show');
                drawer.setAttribute('aria-hidden', 'true');
            }

            openBtn && openBtn.addEventListener('click', openDrawer);
            closeBtn && closeBtn.addEventListener('click', closeDrawer);
            backdrop && backdrop.addEventListener('click', closeDrawer);
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });
        })();
    </script>
</div>
{% endblock %}

