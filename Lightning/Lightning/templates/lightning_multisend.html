{% extends "admin/base_site.html" %}

{% block content_title %}Мульти-рассылка молний{% endblock %}

{% block content %}
<div class="container-fluid">
    <style>
        .search-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem;
            align-items: center;
        }
        .search-row .form-control {
            min-width: 0;
        }
    </style>
    <div class="row mb-2">
        <div class="col-md-6">
            <h4 class="mb-2">Молнии</h4>
            <form class="mb-2" method="get" role="search">
                <div class="d-flex gap-2 mb-1">
                    <button type="submit" class="btn btn-sm btn-primary">Искать</button>
                    <a
                        class="btn btn-sm btn-outline-secondary"
                        href="?usearch={{ user_search|urlencode }}"
                    >Сбросить</a>
                </div>
                <div class="search-row">
                    <input
                        type="text"
                        name="lsearch"
                        class="form-control form-control-sm"
                        placeholder="Поиск"
                        value="{{ lightning_search }}"
                    >
                    <input type="hidden" name="usearch" value="{{ user_search }}">
                </div>
            </form>
        </div>
        <div class="col-md-6">
            <h4 class="mb-2">Получатели</h4>
            <form class="mb-2" method="get" role="search">
                <div class="d-flex gap-2 mb-1">
                    <button type="submit" class="btn btn-sm btn-primary">Искать</button>
                    <a
                        class="btn btn-sm btn-outline-secondary"
                        href="?lsearch={{ lightning_search|urlencode }}"
                    >Сбросить</a>
                </div>
                <div class="search-row">
                    <input
                        type="text"
                        name="usearch"
                        class="form-control form-control-sm"
                        placeholder="Поиск"
                        value="{{ user_search }}"
                    >
                    <input type="hidden" name="lsearch" value="{{ lightning_search }}">
                </div>
            </form>
        </div>
    </div>
    <form id="multisend-form" method="post">
        {% csrf_token %}
        <div id="persisted-selected" class="d-none"></div>
        <div class="row">
            <div class="col-md-6">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Выбрать</th>
                            <th scope="col">Наименование</th>
                            {% comment %} <th scope="col">Создано</th> {% endcomment %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in lightning_page %}
                            <tr>
                                <td>
                                    <input
                                        type="checkbox"
                                        name="lightning_ids"
                                        value="{{ item.id }}"
                                    >
                                </td>
                                <td>{{ item.name }}</td>
                                {% comment %} <td>{{ item.created_at }}</td> {% endcomment %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3">Нет доступных молний</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <nav aria-label="Пагинация молний">
                    <ul class="pagination">
                        {% if lightning_page.has_previous %}
                            <li class="page-item">
                                <a
                                    class="page-link"
                                    href="?lpage={{ lightning_page.previous_page_number }}&upage={{ telegramuser_page.number }}&lsearch={{ lightning_search|urlencode }}&usearch={{ user_search|urlencode }}"
                                >&laquo;</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                        {% endif %}
                        {% for num in lightning_page.paginator.page_range %}
                            {% if num == lightning_page.number %}
                                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% else %}
                                <li class="page-item">
                                    <a
                                        class="page-link"
                                        href="?lpage={{ num }}&upage={{ telegramuser_page.number }}&lsearch={{ lightning_search|urlencode }}&usearch={{ user_search|urlencode }}"
                                    >{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        {% if lightning_page.has_next %}
                            <li class="page-item">
                                <a
                                    class="page-link"
                                    href="?lpage={{ lightning_page.next_page_number }}&upage={{ telegramuser_page.number }}&lsearch={{ lightning_search|urlencode }}&usearch={{ user_search|urlencode }}"
                                >&raquo;</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            <div class="col-md-6">
                <h4>Получатели</h4>
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Выбрать</th>
                            <th scope="col">ФИО</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in telegramuser_page %}
                            <tr>
                                <td>
                                    <input
                                        type="checkbox"
                                        name="user_ids"
                                        value="{{ user.id }}"
                                    >
                                </td>
                                <td>{{ user.full_name }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="2">Нет доступных пользователей</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <nav aria-label="Пагинация пользователей">
                    <ul class="pagination">
                        {% if telegramuser_page.has_previous %}
                            <li class="page-item">
                                <a
                                    class="page-link"
                                    href="?lpage={{ lightning_page.number }}&upage={{ telegramuser_page.previous_page_number }}&lsearch={{ lightning_search|urlencode }}&usearch={{ user_search|urlencode }}"
                                >&laquo;</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                        {% endif %}
                        {% for num in telegramuser_page.paginator.page_range %}
                            {% if num == telegramuser_page.number %}
                                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% else %}
                                <li class="page-item">
                                    <a
                                        class="page-link"
                                        href="?lpage={{ lightning_page.number }}&upage={{ num }}&lsearch={{ lightning_search|urlencode }}&usearch={{ user_search|urlencode }}"
                                    >{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        {% if telegramuser_page.has_next %}
                            <li class="page-item">
                                <a
                                    class="page-link"
                                    href="?lpage={{ lightning_page.number }}&upage={{ telegramuser_page.next_page_number }}&lsearch={{ lightning_search|urlencode }}&usearch={{ user_search|urlencode }}"
                                >&raquo;</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        <div class="row mt-4 g-3">
            <div class="col-md-6">
                <h6>Выбранные молнии</h6>
                <table class="table table-sm table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Наименование</th>
                            {% comment %} <th>Создано</th> {% endcomment %}
                        </tr>
                    </thead>
                    <tbody id="selected-lightnings-body">
                        <tr><td colspan="2" class="text-muted">Нет выбранных</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Выбранные получатели</h6>
                <table class="table table-sm table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ФИО</th>
                        </tr>
                    </thead>
                    <tbody id="selected-users-body">
                        <tr><td class="text-muted">Нет выбранных</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Отправить</button>
        </div>
    </form>
</div>

<script>
// Клиентская память выбранных чекбоксов: сохраняем в localStorage,
// чтобы при смене страниц пагинации выбор не терялся.
(function () {
    const storageKey = 'lightning_multisend_selection';
    const form = document.getElementById('multisend-form');
    const lightningBoxes = Array.from(document.querySelectorAll('input[name="lightning_ids"]'));
    const userBoxes = Array.from(document.querySelectorAll('input[name="user_ids"]'));
    const hiddenContainer = document.getElementById('persisted-selected');
    const selectedLightningsBody = document.getElementById('selected-lightnings-body');
    const selectedUsersBody = document.getElementById('selected-users-body');

    // Если страница перезагружена (F5/Reload), очищаем сохранённый выбор.
    (function clearOnReload() {
        try {
            const nav = performance.getEntriesByType('navigation')[0];
            const isReload = nav ? nav.type === 'reload' : performance.navigation.type === performance.navigation.TYPE_RELOAD;
            if (isReload) {
                localStorage.removeItem(storageKey);
            }
        } catch (e) {
            // Молча продолжаем, если API недоступно.
        }
    })();

    // Нормализация состояния (переход со старого формата id-строк на объекты).
    function normalizeState(raw) {
        const fallback = { lightnings: [], users: [] };
        if (!raw) return fallback;
        const normalizeList = (arr) => {
            if (!Array.isArray(arr)) return [];
            return arr.map((item) => {
                if (typeof item === 'string') {
                    return { id: item, label: '', meta: '' };
                }
                if (item && typeof item === 'object') {
                    return {
                        id: item.id ? String(item.id) : '',
                        label: item.label || '',
                        meta: item.meta || '',
                    };
                }
                return null;
            }).filter(Boolean);
        };
        return {
            lightnings: normalizeList(raw.lightnings),
            users: normalizeList(raw.users),
        };
    }

    // Читаем текущее состояние из localStorage.
    function loadState() {
        try {
            const raw = JSON.parse(localStorage.getItem(storageKey)) || { lightnings: [], users: [] };
            return normalizeState(raw);
        } catch (e) {
            return { lightnings: [], users: [] };
        }
    }

    // Сохраняем состояние.
    function saveState(state) {
        localStorage.setItem(storageKey, JSON.stringify(state));
    }

    // Применяем сохранённый выбор к чекбоксам текущей страницы.
    function applyStateToPage(state) {
        lightningBoxes.forEach((box) => {
            box.checked = state.lightnings.some((item) => item.id === box.value);
        });
        userBoxes.forEach((box) => {
            box.checked = state.users.some((item) => item.id === box.value);
        });
    }

    // Обновляем состояние при изменении чекбокса (сохраняем id, наименование, дату).
    function handleBoxChange(state, box, key) {
        const row = box.closest('tr');
        const cells = row ? Array.from(row.querySelectorAll('td')) : [];
        if (key === 'lightnings') {
            const label = cells[1] ? cells[1].innerText.trim() : '';
            const meta = cells[2] ? cells[2].innerText.trim() : '';
            if (box.checked) {
                const idx = state.lightnings.findIndex((v) => v.id === box.value);
                const payload = { id: box.value, label, meta };
                if (idx === -1) {
                    state.lightnings.push(payload);
                } else {
                    state.lightnings[idx] = payload;
                }
            } else {
                state.lightnings = state.lightnings.filter((v) => v.id !== box.value);
            }
        } else {
            const label = cells[1] ? cells[1].innerText.trim() : '';
            if (box.checked) {
                const idx = state.users.findIndex((v) => v.id === box.value);
                const payload = { id: box.value, label, meta: '' };
                if (idx === -1) {
                    state.users.push(payload);
                } else {
                    state.users[idx] = payload;
                }
            } else {
                state.users = state.users.filter((v) => v.id !== box.value);
            }
        }
        saveState(state);
        renderSelected(state);
    }

    // Отрисовываем таблицы выбранных элементов.
    function renderSelected(state) {
        selectedLightningsBody.innerHTML = '';
        if (!state.lightnings.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="2" class="text-muted">Нет выбранных</td>';
            selectedLightningsBody.appendChild(tr);
        } else {
            state.lightnings.forEach((item) => {
                const tr = document.createElement('tr');
                const title = item.label || `ID ${item.id}`;
                const meta = item.meta || '';
                tr.innerHTML = `<td>${title}</td><td>${meta}</td>`;
                selectedLightningsBody.appendChild(tr);
            });
        }

        selectedUsersBody.innerHTML = '';
        if (!state.users.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td class="text-muted">Нет выбранных</td>';
            selectedUsersBody.appendChild(tr);
        } else {
            state.users.forEach((item) => {
                const tr = document.createElement('tr');
                const title = item.label || `ID ${item.id}`;
                tr.innerHTML = `<td>${title}</td>`;
                selectedUsersBody.appendChild(tr);
            });
        }
    }

    // Добавляем скрытые инпуты со всеми выбранными ID перед отправкой формы.
    function appendHiddenInputs(state) {
        hiddenContainer.innerHTML = '';
        state.lightnings.forEach((item) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'lightning_ids';
            input.value = item.id;
            hiddenContainer.appendChild(input);
        });
        state.users.forEach((item) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'user_ids';
            input.value = item.id;
            hiddenContainer.appendChild(input);
        });
    }

    // Инициализация: подтягиваем сохранённое состояние и навешиваем обработчики.
    const state = loadState();
    applyStateToPage(state);
    renderSelected(state);

    lightningBoxes.forEach((box) => {
        box.addEventListener('change', () => handleBoxChange(state, box, 'lightnings'));
    });
    userBoxes.forEach((box) => {
        box.addEventListener('change', () => handleBoxChange(state, box, 'users'));
    });

    form.addEventListener('submit', () => {
        // Перед отправкой формы обновим состояние по текущей странице.
        lightningBoxes.forEach((box) => handleBoxChange(state, box, 'lightnings'));
        userBoxes.forEach((box) => handleBoxChange(state, box, 'users'));
        appendHiddenInputs(state);
        // Очищаем состояние сразу: сброс локального хранилища и UI.
        localStorage.removeItem(storageKey);
        state.lightnings = [];
        state.users = [];
        renderSelected(state);
        lightningBoxes.forEach((box) => { box.checked = false; });
        userBoxes.forEach((box) => { box.checked = false; });
    });
})();
</script>
{% endblock %}