{% extends "admin/base_site.html" %}

{% block content_title %}Статистика молний{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1200px;">

    <!-- Выбор молнии -->
    <form method="get" class="mb-3 d-flex gap-2 justify-content-center">
        <select name="lightning_id" class="form-select form-select-sm" style="max-width: 420px;" onchange="this.form.submit()">
            <option value="">Выберите молнию</option>
            {% for lightning in lightnings %}
            <option value="{{ lightning.id }}" {% if lightning == selected_lightning %}selected{% endif %}>{{ lightning.name }}</option>
            {% endfor %}
        </select>
    </form>

    {% if selected_lightning %}
    <!-- Карточки-метрики -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-5 g-2 mb-3">
        <div class="col">
            <a class="text-decoration-none" href="?lightning_id={{ selected_lightning.id }}&user_filter=all">
                <div class="card shadow-sm h-100 border border-secondary">
                    <div class="card-body text-center">
                        <div class="text-muted">Участники</div>
                        <div class="display-6">{{ total_participants }}</div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a class="text-decoration-none" href="?lightning_id={{ selected_lightning.id }}&user_filter=read">
                <div class="card shadow-sm h-100 border border-secondary">
                    <div class="card-body text-center">
                        <div class="text-success">Ознакомились</div>
                        <div class="display-6">{{ read_count }}</div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a class="text-decoration-none" href="?lightning_id={{ selected_lightning.id }}&user_filter=not_read">
                <div class="card shadow-sm h-100 border border-secondary">
                    <div class="card-body text-center">
                        <div class="text-danger">Не ознакомились</div>
                        <div class="display-6">{{ not_read_count }}</div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a class="text-decoration-none" href="?lightning_id={{ selected_lightning.id }}&user_filter=completed_tests">
                <div class="card shadow-sm h-100 border border-secondary">
                    <div class="card-body text-center">
                        <div class="text-primary">Сдали тест</div>
                        <div class="display-6">{{ completed_tests }}</div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a class="text-decoration-none" href="?lightning_id={{ selected_lightning.id }}&user_filter=not_completed_tests">
                <div class="card shadow-sm h-100 border border-secondary">
                    <div class="card-body text-center">
                        <div class="text-warning">Не сдали тест</div>
                        <div class="display-6">{{ not_completed_tests }}</div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Таблица пользователей -->
    {% if user_list %}
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Список пользователей</strong>
            <div class="small text-muted">Всего: {{ page_obj.paginator.count }}</div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ФИО</th>
                        <th>Телефон</th>
                        <th>Должность</th>
                        <th>Подразделение</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in user_list %}
                    <tr>
                        <td>{{ user.full_name }}</td>
                        <td>{{ user.phone }}</td>
                        <td>{{ user.job_title }}</td>
                        <td>{{ user.department }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if page_obj and page_obj.paginator.num_pages > 1 %}
        <div class="card-footer d-flex justify-content-center">
            <nav>
                <ul class="pagination mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?lightning_id={{ selected_lightning.id }}&user_filter={{ request.GET.user_filter }}&page={{ page_obj.previous_page_number }}">Назад</a>
                    </li>
                    {% endif %}
                    <li class="page-item disabled"><span class="page-link">Стр. {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span></li>
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?lightning_id={{ selected_lightning.id }}&user_filter={{ request.GET.user_filter }}&page={{ page_obj.next_page_number }}">Вперёд</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
    {% elif selected_lightning %}
        <div class="alert alert-info">Нет данных для выбранного фильтра.</div>
    {% endif %}
</div>
{% endblock %}
