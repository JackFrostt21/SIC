{% extends 'admin/base.html' %}

{% block content %}
<div style="width: 100%;">
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
    <div style="display: flex; justify-content: center; margin-bottom: 20px;">
        <button onclick="showTab('tab-courses')" class="tab-button {% if current_tab == 'tab-courses' %}active-tab{% endif %}">–û–±—É—á–∞—é—â–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</button>
        <button onclick="showTab('tab-students')" class="tab-button {% if current_tab == 'tab-students' %}active-tab{% endif %}">–°—Ç—É–¥–µ–Ω—Ç—ã</button>
        <button onclick="showTab('tab-statistics')" class="tab-button {% if current_tab == 'tab-statistics' %}active-tab{% endif %}">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
    <div id="tab-courses" class="tab-content" style="display: {% if current_tab == 'tab-courses' %}block{% else %}none{% endif %};">
        <h2>–û–±—É—á–∞—é—â–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h2>
        <form id="filter-form" method="get" class="mb-3" style="display: flex; gap: 10px; align-items: center;">
            <input type="hidden" name="current_tab" value="tab-courses">
            <label for="search">–ü–æ–∏—Å–∫:</label>
            <input type="text" id="search" name="search" value="{{ search_query }}">
            <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <input type="hidden" id="hide-archived-input" name="hide_archived" value="{% if hide_archived %}on{% endif %}">
        </form>
        <div class="scrollable-table">
            <table class="table">
                <p></p>
                <button type="button" id="toggle-hide-archived" class="toggle-button {% if hide_archived %}active{% endif %}">
                    –°–∫—Ä—ã—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–µ
                </button>
                <p></p>
                <thead>
                    <tr>
                        <th>–ö–∞—Ä—Ç–∏–Ω–∫–∞</th>
                        <th>–ü—Ä–æ–≥—Ä–∞–º–º–∞</th>
                        <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                        <th>–ê–≤—Ç–æ—Ä</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                        <th>–ê—Ä—Ö–∏–≤</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in courses %}
                    <tr>
                        <td>
                            {% if course.image_course %}
                                <img src="{{ course.image_course.url }}" style="max-width: 50px;" alt="–ö–∞—Ä—Ç–∏–Ω–∫–∞" class="image-course">
                            {% else %}
                                –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            {% endif %}
                        </td>
                        <td><a href="{% url 'trainingcourse_custom' course_id=course.id %}">{{ course.title }}</a></td>
                        <td>{{ course.course_direction.title|default:"-" }}</td>
                        <td>{{ course.author|default:"-" }}</td>
                        <td>{{ course.created_at|date:"d.m.Y" }}</td>
                        <td>{% if course.is_actual %}‚úÖ{% else %}‚ùå{% endif %}</td>
                        <td>{% if course.archive %}‚úÖ{% else %}‚ùå{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>


    <div id="tab-students" class="tab-content" style="display: {% if current_tab == 'tab-students' %}block{% else %}none{% endif %};">
        <h2>–°—Ç—É–¥–µ–Ω—Ç—ã</h2>
        <form method="get">
            <input type="hidden" name="current_tab" value="tab-students">
            <label for="student_search">–ü–æ–∏—Å–∫:</label>
            <input type="text" id="student_search" name="student_search" value="{{ student_search_query }}">
            <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </form>
        <div class="scrollable-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>–§–æ—Ç–æ</th>
                        <th>–§–∞–º–∏–ª–∏—è</th>
                        <th>–ò–º—è</th>
                        <th>–û—Ç—á–µ—Å—Ç–≤–æ</th>
                        <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                        <th>Telegram ID</th>
                        <th>–ì—Ä—É–ø–ø–∞</th>
                        <th>–ê–∫—Ç–∏–≤–Ω—ã–π</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>
                            {% if student.image %}
                                <img src="{{ student.image }}" style="max-width: 50px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                –ù–µ—Ç —Ñ–æ—Ç–æ
                            {% endif %}
                        </td>
                        <td>{{ student.last_name|default:"-" }}</td>
                        <td>{{ student.first_name|default:"-" }}</td>
                        <td>{{ student.middle_name|default:"-" }}</td>
                        <td>{{ student.company|default:"-" }}</td>
                        <td>{{ student.user_id }}</td>
                        <td>{{ student.groups|default:"-" }}</td>
                        <td>{% if student.is_active %}‚úÖ{% else %}‚ùå{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div id="tab-statistics" class="tab-content" style="display: {% if current_tab == 'tab-statistics' %}block{% else %}none{% endif %};">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <form method="get">
            <input type="hidden" name="current_tab" value="tab-statistics">
            <label for="stats_search">–ü–æ–∏—Å–∫ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É:</label>
            <input type="text" id="stats_search" name="stats_search" value="{{ stats_search_query }}">
            <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </form>
        <div class="scrollable-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>–§–æ—Ç–æ</th>
                        <th>–§–ò–û</th>
                        <th>–ù–∞–∑–Ω–∞—á–µ–Ω–æ</th>
                        <th>–°–¥–∞–Ω–æ</th>
                        <th>–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç % </th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in statistics %}
                    <tr>
                        <td>
                            {% if stat.image %}
                                <img src="{{ stat.image }}" alt="–§–æ—Ç–æ" style="max-width: 50px;">
                            {% else %}
                                <span style="font-size: 18px; color: gray;">üñºÔ∏è –ù–µ—Ç —Ñ–æ—Ç–æ</span>
                            {% endif %}
                        </td>
                        <td>{{ stat.full_name }}</td>
                        <td>{{ stat.assigned }}</td>
                        <td>{{ stat.completed }}</td>
                        <td>{{ stat.success_rate }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
        <div class="chart-container" style="margin-top: 40px;">
            <h3>–ù–∞–∑–Ω–∞—á–µ–Ω–æ –∏ –°–¥–∞–Ω–æ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</h3>
            <canvas id="assignedCompletedChart"></canvas>
        </div>

        <div class="chart-container" style="margin-top: 40px;">
            <h3>–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º (%)</h3>
            <canvas id="successRateChart"></canvas>
        </div>

        <!-- –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
        <script>
            var statisticsData = {{ statistics_json|safe }};
        </script>
    </div>    
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Chart.js —á–µ—Ä–µ–∑ CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .tab-button {
        padding: 10px 20px;
        margin: 0 5px;
        border: 1px solid #ccc;
        background: #2a4d69;
        color: white;
        cursor: pointer;
    }

    .tab-button.active-tab {
        background: #007bff;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .toggle-button {
        padding: 10px 20px;
        border: 1px solid #ccc;
        background: #e0e0e0;
        color: black;
        cursor: pointer;
        border-radius: 5px;
    }

    .toggle-button.active {
        background: #007bff;
        color: white;
        font-weight: bold;
    }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
    canvas {
        max-width: 100%;
        height: auto;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
    .chart-container {
        width: 50%; /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ 50% –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
        max-width: 400px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞ */
        margin: 0 auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        position: relative; /* –î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ */
        height: 200px; /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    }

    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
    .chart-container canvas {
        width: 100% !important; /* –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ —à–∏—Ä–∏–Ω–µ */
        height: 100% !important; /* –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ –≤—ã—Å–æ—Ç–µ */
    }
</style>

<script>
    function showTab(tabId) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        document.getElementById(tabId).style.display = 'block';
        // –£–±—Ä–∞—Ç—å –∫–ª–∞—Å—Å active-tab —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active-tab'));
        // –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å active-tab –∫ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–µ
        document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active-tab');
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ current_tab –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    document.addEventListener('DOMContentLoaded', function() {
        const activeTab = "{{ current_tab }}";
        if (activeTab) {
            showTab(activeTab);
        } else {
            showTab('tab-courses'); // –í–∫–ª–∞–¥–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–∫—Ä—ã—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–µ" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const toggleButton = document.getElementById('toggle-hide-archived');
        if (toggleButton) {
            toggleButton.addEventListener('click', function () {
                const button = this;
                const hideArchivedInput = document.getElementById('hide-archived-input');
                const form = document.getElementById('filter-form');

                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
                if (button.classList.contains('active')) {
                    button.classList.remove('active');
                    hideArchivedInput.value = '';
                } else {
                    button.classList.add('active');
                    hideArchivedInput.value = 'on';
                }

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
                form.submit();
            });
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é statisticsData
        const data = statisticsData;
    
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö
        if (!data || data.length === 0) {
            console.warn('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤.');
            return;
        }
    
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ "–ù–∞–∑–Ω–∞—á–µ–Ω–æ –∏ –°–¥–∞–Ω–æ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º"
        const labels = data.map(stat => stat.full_name);
        const assignedData = data.map(stat => stat.assigned);
        const completedData = data.map(stat => stat.completed);
    
        const ctx1 = document.getElementById('assignedCompletedChart').getContext('2d');
        const assignedCompletedChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '–ù–∞–∑–Ω–∞—á–µ–Ω–æ',
                        data: assignedData,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: '–°–¥–∞–Ω–æ',
                        data: completedData,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // –ü–æ–∑–≤–æ–ª—è–µ—Ç –≥—Ä–∞—Ñ–∏–∫—É –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ
                plugins: {
                    title: {
                        display: true,
                        text: '–ù–∞–∑–Ω–∞—á–µ–Ω–æ –∏ –°–¥–∞–Ω–æ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    },
                    legend: {
                        position: 'top',
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏'
                        }
                    }
                }
            }
        });
    
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ "–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º (%)"
        const successRateData = data.map(stat => stat.success_rate);
    
        const ctx2 = document.getElementById('successRateChart').getContext('2d');
        const successRateChart = new Chart(ctx2, {
            type: 'bar', // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ 'line' –¥–ª—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
            data: {
                labels: labels,
                datasets: [{
                    label: '–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (%)',
                    data: successRateData,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // –ü–æ–∑–≤–æ–ª—è–µ—Ç –≥—Ä–∞—Ñ–∏–∫—É –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ
                plugins: {
                    title: {
                        display: true,
                        text: '–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º (%)'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + '%';
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100, // –ü–æ—Å–∫–æ–ª—å–∫—É —ç—Ç–æ –ø—Ä–æ—Ü–µ–Ω—Ç
                        title: {
                            display: true,
                            text: '–ü—Ä–æ—Ü–µ–Ω—Ç'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏'
                        }
                    }
                }
            }
        });
    });    
</script>
{% endblock %}