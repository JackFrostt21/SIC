{% extends 'admin/base.html' %}

{% block content %}

<!-- Кнопка вызова модального окна -->
<button type="button" id="openDateFilter" style="padding: 8px 12px; cursor: pointer;">
    Фильтр по дате
</button>

<!-- Модальное окно -->
<div id="dateFilterModal" style="
    display: none; 
    position: fixed; 
    z-index: 1000; 
    left: 0; 
    top: 0; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(0,0,0,0.6);
">
    <div style="
        background-color: #fff; 
        margin: 15% auto; 
        padding: 20px; 
        width: 300px; 
        border-radius: 8px;
    ">
        <h3>Выберите даты</h3>
        <form method="get" action="">
            <label>От:</label>
            <input type="date" name="start_date" value="{{ request.GET.start_date }}">

            <label>До:</label>
            <input type="date" name="end_date" value="{{ request.GET.end_date }}">

            <button type="submit" style="margin-top: 10px;">Применить</button>
            <button type="button" id="closeDateFilter" style="background-color: #ccc; margin-left: 10px;">Закрыть</button>
        </form>
    </div>
</div>

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <input type="hidden" name="deleted_users" id="deleted_users" value="">
    <input type="hidden" name="deleted_groups" id="deleted_groups" value="">
    <input type="hidden" name="deleted_job_titles" id="deleted_job_titles" value="">
    <input type="hidden" name="deleted_departments" id="deleted_departments" value="">
    <input type="hidden" name="deleted_messages" id="deleted_messages" value="">
    <input type="hidden" name="question_id" value="{{ selected_question.id }}">
    <input type="hidden" name="lightning_id" value="{{ lightning.id }}">
    
    <div style="display: flex; min-height: 100vh; align-items: stretch;">
        <!-- Левый блок - Список молний (сайдбар) -->
        <div style="width: 10%; padding-right: 20px; min-width: 200px;">
            <h4>Молнии:</h4>
            <table style="width: 100%; border-collapse: collapse; text-align: left;">
                <thead>
                    <tr>
                        <th style="padding: 10px; border: 1px solid #ddd;">Молнии</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Дата</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lightning in lightnings %}
                    <tr>
                        <!-- Ссылка на молнию -->
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <a href="{% url 'lightning_custom' lightning.id %}" style="color:white; text-decoration: none;">
                                {{ lightning.title|default:lightning.id }}
                            </a>
                        </td>
                        <!-- Дата создания -->
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            {{ lightning.created_at|date:"d.m.Y" }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" style="text-align: center; padding: 10px; border: 1px solid #ddd;">Нет молний</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="button" onclick="window.location.href='{% url 'lightning_custom_create' %}'" class="create-button">
                Создать молнию
            </button>
        </div>

        <!-- Разделяющая вертикальная линия -->
        <div class="vertical-divider"></div>

        <!-- Сайдбар вопросов (появляется только на вкладке "Тестирование") -->
        <div id="question-sidebar" class="hidden" style="width: 10%; padding-left: 20px; padding-right: 20px; min-width: 200px;">
            <h4>Вопросы:</h4>
            <ul style="list-style: none; padding: 0;">
                {% if lightning.pk %}  <!-- Проверка наличия pk у объекта lightning -->
                    {% for question in lightning.questions.all %}
                    <li style="padding: 5px; border: 1px solid #ddd; margin-bottom: 1px; background-color: #00234b;">
                        <!-- Добавляем ссылку на каждый вопрос -->
                        <a href="{% url 'lightning_question_detail' lightning.id question.id %}" style="color: white;">
                            {{ question.title|default:question.id }}
                        </a>
                    </li>
                    {% endfor %}
                {% else %}
                    <li style="padding: 5px; border: 1px solid #ddd; margin-bottom: 1px; background-color: #f0f8ff;">
                        Нет доступных вопросов
                    </li>
                {% endif %}
            </ul>
            <button type="button" onclick="createQuestion()">Создать вопрос</button>
        </div>

        <!-- Разделяющая вертикальная линия -->
        <div class="vertical-divider"></div>

    

        <!-- Правый блок - Информация о выбранной молнии -->
        <div style="width: 70%; padding-left: 20px;">
            {% if lightning %}
            <!-- Заголовок по центру -->
            <h2 style="text-align: center;">Молния: {{ lightning.title }}</h2>
            <hr style="border: 1px solid black;" />

            <!-- Вкладки -->
            <div style="display: flex; justify-content: flex-start; margin-bottom: 20px;">
                <button type="button" class="tab-button" onclick="showTab('main')">Основное меню</button>
                <button type="button" class="tab-button" onclick="showTab('messages')">Сообщения</button>
                <button type="button" class="tab-button" onclick="showTab('testing')">Тестирование</button>
            </div>

            <div id="tab-content">
                <div id="main" class="tab-content" style="display: block;">
                    <!-- Кнопка "Отправить молнию" -->
                    <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="send-lightning-button">Отправить молнию</button>
                    </div>   

                    <!-- Информация о молнии -->
                    <div style="display: flex; justify-content: space-between;">
                        <div style="width: 75%; padding-right: 10px;">
                            <!-- Поля с вводом текста под названием -->
                            <p><strong>Название молнии:</strong></p>
                            <input type="text" name="title" value="{{ lightning.title }}" style="width: 133%; margin-bottom: 10px;">

                            <p><strong>Дата создания:</strong></p>
                            <input type="text" value="{{ lightning.created_at|date:'d.m.Y H:i' }}" readonly style="width: 133%; margin-bottom: 10px;">

                            {% comment %} <p><strong>Описание последствий:</strong></p>
                            <input type="text" name="description_of_consequences" value="{{ lightning.description_of_consequences|default_if_none:'' }}" style="width: 133%; margin-bottom: 10px;">

                            <p><strong>Место инцидента:</strong></p>
                            <input type="text" name="incident_location" value="{{ lightning.incident_location|default_if_none:'' }}" style="width: 133%; margin-bottom: 10px;">

                            <p><strong>Координаты инцидента:</strong></p>
                            <input type="text" name="incident_coordinates" value="{{ lightning.incident_coordinates|default_if_none:'' }}" style="width: 133%; margin-bottom: 10px;">

                            <p><strong>План мероприятий по ликвидации инцидента:</strong></p>
                            <input type="text" name="plan_of_action" value="{{ lightning.plan_of_action|default_if_none:'' }}" style="width: 133%; margin-bottom: 10px;">

                            <p><strong>Ответственные:</strong></p>
                            <input type="text" name="responsible_persons" value="{{ lightning.responsible_persons|default_if_none:'' }}" style="width: 133%; margin-bottom: 10px;"> {% endcomment %}

                            <p><strong>Минимальный процент сдачи теста:</strong></p>
                            <input type="number" name="min_test_percent_course" value="{{ lightning.min_test_percent_course }}" min="0" max="100" style="width: 133%; margin-bottom: 10px;">
                        </div>
                    </div>

                    <!-- Адресаты молнии -->
                    <h4 style="text-align: left; margin-top: 20px;">Адресаты молнии:</h4>
                    <div style="display: flex; justify-content: flex-start; gap: 20px; margin-bottom: 20px;">
                        {% if lightning.pk %}
                        <!-- Блок пользователей -->
                        <div style="width: 30%; border: 1px solid #ddd; padding: 10px; background-color: #f0f8ff; border-radius: 8px;">
                            <h4 style="text-align: center; color: #00234b;">Пользователи</h4>
                            <table style="width: 100%;">
                                <tbody id="lightning-users-list">
                                    {% for user in lightning.user.all %}
                                    <tr data-user-id="{{ user.id }}"> <!-- Добавляем data-user-id -->
                                        <td style="padding: 5px; border: 1px solid #ddd; background-color: #00234b; color: white; text-align: center;">
                                            {{ user.full_name }}
                                        </td>
                                        <td style="width: 30px; text-align: center;">
                                            <button type="button" style="background: none; border: none; color: red;" onclick="removeUserRow(this)">&#10060;</button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" style="text-align: center;">Пользователей пока нет</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <button type="button" onclick="addUserRow()" style="width: 100%; margin-top: 10px;">+ Добавить пользователя</button>
                        </div>

                        <!-- Блок групп -->
                        <div style="width: 30%; border: 1px solid #ddd; padding: 10px; background-color: #f0f8ff; border-radius: 8px;">
                            <h4 style="text-align: center; color: #00234b;">Группы</h4>
                            <table style="width: 100%;">
                                <tbody id="lightning-groups-list">
                                    {% for group in lightning.group.all %}
                                    <tr data-group-id="{{ group.id }}"> <!-- Добавляем data-group-id -->
                                        <td style="padding: 5px; border: 1px solid #ddd; background-color: #00234b; color: white; text-align: center;">
                                            {{ group.name }}
                                        </td>
                                        <td style="width: 30px; text-align: center;">
                                            <button type="button" style="background: none; border: none; color: red;" onclick="removeGroupRow(this)">&#10060;</button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" style="text-align: center;">Групп пока нет</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <button type="button" onclick="addGroupRow()" style="width: 100%; margin-top: 10px;">+ Добавить группу</button>
                        </div>

                        <!-- Блок должностей -->
                        <div style="width: 30%; border: 1px solid #ddd; padding: 10px; background-color: #f0f8ff; border-radius: 8px;">
                            <h4 style="text-align: center; color: #00234b;">Должности</h4>
                            <table style="width: 100%;">
                                <tbody id="lightning-job-titles-list">
                                    {% for job_title in lightning.job_titles.all %}
                                    <tr data-job-title-id="{{ job_title.id }}"> <!-- Добавляем data-job-title-id -->
                                        <td style="padding: 5px; border: 1px solid #ddd; background-color: #00234b; color: white; text-align: center;">
                                            {{ job_title.title }}
                                        </td>
                                        <td style="width: 30px; text-align: center;">
                                            <button type="button" style="background: none; border: none; color: red;" onclick="removeJobTitleRow(this)">&#10060;</button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" style="text-align: center;">Должностей пока нет</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <button type="button" onclick="addJobTitleRow()" style="width: 100%; margin-top: 10px;">+ Добавить должность</button>
                        </div>

                        <!-- Блок подразделений -->
                        <div style="width: 30%; border: 1px solid #ddd; padding: 10px; background-color: #f0f8ff; border-radius: 8px;">
                            <h4 style="text-align: center; color: #00234b;">Подразделения</h4>
                            <table style="width: 100%;">
                                <tbody id="lightning-departments-list">
                                    {% for department in lightning.department.all %}
                                    <tr data-department-id="{{ department.id }}">
                                        <td style="padding: 5px; border: 1px solid #ddd; background-color: #00234b; color: white; text-align: center;">
                                            {{ department.title }}
                                        </td>
                                        <td style="width: 30px; text-align: center;">
                                            <button type="button" style="background: none; border: none; color: red;" onclick="removeDepartmentRow(this)">&#10060;</button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" style="text-align: center;">Подразделений пока нет</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <button type="button" onclick="addDepartmentRow()" style="width: 100%; margin-top: 10px;">+ Добавить подразделение</button>
                        </div>
                        {% endif %}
                    </div>
                </div>                

                <div id="messages" class="tab-content" style="display: none;">
                    <div id="messages-container">
                        {% for message in lightning_messages %}
                        <div class="message-block" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; position: relative; background-color: #f9f9f9;">
                            <!-- Кнопка удаления сообщения -->
                            <button type="button" class="delete-message-button" onclick="removeMessageBlock(this, '{{ message.id }}')" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 18px; cursor: pointer;">&#10060;</button>
                
                            <!-- ID сообщения -->
                            <input type="hidden" name="message_id[]" value="{{ message.id }}">
                
                            <div style="margin-bottom: 15px;">
                                <label><strong>Сообщение:</strong></label>
                                <textarea name="message_content[]" style="width: 100%; padding: 8px; margin-top: 5px;">{{ message.content }}</textarea>
                            </div>
                
                            <div style="margin-bottom: 15px;">
                                <label><strong>Наименование кнопки в ТГ (до 25 символов):</strong></label>
                                <input type="text" name="button_text[]" maxlength="25" style="width: 100%; padding: 8px; margin-top: 5px;" value="{{ message.button_text|default:'Далее' }}">
                            </div>
                
                            <div style="margin-bottom: 15px;">
                                <label><strong>Порядок сообщения:</strong></label>
                                <input type="number" name="order[]" style="width: 100px; padding: 8px; margin-top: 5px;" value="{{ message.order }}">
                            </div>
                
                            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                                <label><input type="checkbox" name="send_text[]" value="1" {% if message.send_text %}checked{% endif %}> Отправлять текст</label>
                                <label><input type="checkbox" name="send_file[]" value="1" {% if message.send_file %}checked{% endif %}> Отправлять файл</label>
                            </div>
                
                            <div style="margin-bottom: 15px;">
                                <label><strong>Изображение для сообщения:</strong></label>
                                <input type="file" name="image_lightning_{{ forloop.counter0 }}" style="display: block; margin-top: 5px;">
                                {% if message.image_lightning %}
                                    <p style="margin-top: 5px; font-size: 14px;">Текущий файл: <a href="{{ message.image_lightning.url }}" target="_blank">{{ message.image_lightning.url }}</a></p>
                                    <button type="button" onclick="deleteImage('{{ forloop.counter0 }}')" style="padding: 5px 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">Удалить изображение</button>
                                {% endif %}
                            </div>
                
                            <div style="margin-bottom: 15px;">
                                <label><strong>Файл для сообщения:</strong></label>
                                <input type="file" name="file_lightning_{{ forloop.counter0 }}" style="display: block; margin-top: 5px;">
                                {% if message.file_lightning %}
                                    <p style="margin-top: 5px; font-size: 14px;">Текущий файл: <a href="{{ message.file_lightning.url }}" target="_blank">{{ message.file_lightning.url }}</a></p>
                                    <button type="button" onclick="deleteFile('{{ forloop.counter0 }}')" style="padding: 5px 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">Удалить файл</button>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p>Нет сообщений.</p>
                        {% endfor %}
                    </div>
                
                    <button type="button" onclick="addMessageBlock()" style="display: block; width: 100%; padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">Добавить Сообщение</button>
                </div>
                
                <div id="testing" class="tab-content" style="display: none;">
                    {% if selected_question %}
                        <!-- Отображение данных выбранного вопроса -->
                        <label>Молния:</label>
                        <select name="lightning_id" required>
                            <option value="" disabled {% if not selected_question.lightning %}selected{% endif %}>Выберите молнию</option>
                            {% for l in lightnings %}
                                <option value="{{ l.id }}" {% if selected_question.lightning and selected_question.lightning.id == l.id %}selected{% endif %}>
                                    {{ l.title }}
                                </option>
                            {% endfor %}
                        </select><br>
                        <label>Отображать вопрос:</label>
                        <input type="checkbox" name="display_question" {% if selected_question.is_display_question %}checked{% endif %}><br>
                        <label>Множественный выбор:</label>
                        <input type="checkbox" name="multiple_choice" {% if selected_question.is_multiple_choice %}checked{% endif %}><br>
                
                        <label>Текст вопроса:</label>
                        <input type="text" name="question_text" value="{{ selected_question.title }}" style="width: 100%;"><br>
                
                        <label>Номер вопроса:</label>
                        <input type="number" name="question_order" value="{{ selected_question.order }}" style="width: 100px;"><br>
                
                        <h4>Ответы:</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th>Отобразить</th>
                                    <th>Верно</th>
                                    <th>Текст ответа</th>
                                    <th>Номер</th>
                                    <th>Действие</th>
                                </tr>
                            </thead>
                            <tbody id="answers-table">
                                {% for answer in selected_question.answer.all %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="display_answer[]" value="{{ forloop.counter0 }}" 
                                               {% if answer.is_display_answer %}checked{% endif %}>
                                    </td>
                                    <td>
                                        <input type="checkbox" name="is_correct[]" value="{{ forloop.counter0 }}" 
                                               {% if answer.is_correct %}checked{% endif %}>
                                    </td>
                                    <td>
                                        <input type="text" name="answer_text[]" value="{{ answer.text }}" style="width: 100%;">
                                        <input type="hidden" name="answer_id[]" value="{{ answer.id }}">
                                    </td>
                                    <td>
                                        <input type="text" name="answer_number[]" value="{{ answer.number }}" style="width: 50px;">
                                    </td>
                                    <td>
                                        <button type="button" onclick="removeAnswerRow(this)" style="color: red; background: none; border: none; font-size: 16px; cursor: pointer;">
                                            &#10060;
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <!-- Кнопка для добавления нового ответа -->
                        <button type="button" onclick="addAnswerRow()">+ Добавить вариант ответа</button>                        
                        
                        {% if selected_question.pk %}
                        <!-- Кнопка для удаления вопроса, выравнивание по центру -->
                        <div style="margin-top: 20px; text-align: left;">
                            <a href="{% url 'question_delete' selected_question.id %}" class="delete-button">Удалить вопрос</a>
                        </div>
                        {% endif %}                       
                    {% else %}
                        <p>Выберите вопрос, чтобы отобразить его детали.</p>
                    {% endif %}
                </div>

            <!-- Кнопки для сохранения и удаления -->
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <div>
                    <button type="submit" class="save-button" style="margin-right: 10px;">СОХРАНИТЬ</button>
                    {% if lightning.pk %}
                    <!-- Удаление через стандартную форму Django -->
                    <a href="{% url 'lightning_delete' lightning.id %}" class="delete-button">Удалить</a>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <p>Выберите молнию для просмотра деталей.</p>
            {% endif %}
        </div>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('dateFilterModal');
        const openButton = document.getElementById('openDateFilter');
        const closeButton = document.getElementById('closeDateFilter');

        openButton.addEventListener('click', function () {
            modal.style.display = 'block';
        });

        closeButton.addEventListener('click', function () {
            modal.style.display = 'none';
        });
    });
</script>

<script>
    function deleteImage(counter) {
        // Добавьте скрытое поле для отметки, что изображение нужно удалить
        let input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'delete_image_' + counter;
        input.value = '1';
        document.getElementsByName('image_lightning_' + counter)[0].closest('.message-block').appendChild(input);
        // Скрываем текущий файл и кнопку
        event.target.previousElementSibling.style.display = 'none';
        event.target.style.display = 'none';
    }

    function deleteFile(counter) {
        // Добавьте скрытое поле для отметки, что файл нужно удалить
        let input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'delete_file_' + counter;
        input.value = '1';
        document.getElementsByName('file_lightning_' + counter)[0].closest('.message-block').appendChild(input);
        // Скрываем текущий файл и кнопку
        event.target.previousElementSibling.style.display = 'none';
        event.target.style.display = 'none';
    }
</script>

<script>
    document.querySelector('.send-lightning-button').addEventListener('click', function () {
        const lightningId = "{{ lightning.id }}";  // ID молнии из контекста

        if (lightningId) {
            fetch("/ru/send_lightning/" + lightningId + "/", {  // Используем путь с префиксом 'ru'
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',  // Для защиты от CSRF-атак
                }
            }).then(response => {
                if (response.ok) {
                    alert('Молния отправлена успешно!');
                } else {
                    alert('Ошибка при отправке молнии.');
                }
            }).catch(error => {
                console.error('Ошибка:', error);
            });
        } else {
            alert('Ошибка: Молния не выбрана.');
        }
    });
</script>

<script>
    // Добавление строки с выпадающим списком для пользователей
    function addUserRow() {
        const userRow = `
            <li style="padding: 5px; margin-bottom: 1px;">
                <select name="users" style="width: 100%;">
                    {% for user in users %}
                        <option value="{{ user.id }}">{{ user.full_name }}</option>
                    {% endfor %}
                </select>
            </li>
        `;
        document.getElementById('lightning-users-list').insertAdjacentHTML('beforeend', userRow);
    }

    // Функция для удаления строки пользователя и добавления его ID в скрытое поле
    function removeUserRow(button) {
        const row = button.closest('tr');
        const userId = row.getAttribute('data-user-id');  // Получаем ID пользователя из атрибута data-user-id
        row.remove();

        // Добавляем ID удаленного пользователя в скрытое поле
        let deletedUsers = document.getElementById('deleted_users').value;
        document.getElementById('deleted_users').value = deletedUsers ? deletedUsers + ',' + userId : userId;
    }

    // Добавление строки с выпадающим списком для групп
    function addGroupRow() {
        const groupRow = `
            <li style="padding: 5px; margin-bottom: 1px;">
                <select name="groups" style="width: 100%;">
                    {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </li>
        `;
        document.getElementById('lightning-groups-list').insertAdjacentHTML('beforeend', groupRow);
    }


    // Функция для удаления строки группы и добавления её ID в скрытое поле
    function removeGroupRow(button) {
        const row = button.closest('tr');
        const groupId = row.getAttribute('data-group-id');  // Получаем ID группы из атрибута data-group-id
        row.remove();

        // Добавляем ID удаленной группы в скрытое поле
        let deletedGroups = document.getElementById('deleted_groups').value;
        document.getElementById('deleted_groups').value = deletedGroups ? deletedGroups + ',' + groupId : groupId;
    }

    // Добавление строки с выпадающим списком для должностей
    function addJobTitleRow() {
        const jobTitleRow = `
            <li style="padding: 5px; margin-bottom: 1px;">
                <select name="job_titles" style="width: 100%;">
                    {% for job_title in job_titles %}
                        <option value="{{ job_title.id }}">{{ job_title.title }}</option>
                    {% endfor %}
                </select>
            </li>
        `;
        document.getElementById('lightning-job-titles-list').insertAdjacentHTML('beforeend', jobTitleRow);
    }

    // Функция для удаления строки должности и добавления её ID в скрытое поле
    function removeJobTitleRow(button) {
        const row = button.closest('tr');
        const jobTitleId = row.getAttribute('data-job-title-id');  // Получаем ID должности из атрибута data-job-title-id
        row.remove();

        // Добавляем ID удаленной должности в скрытое поле
        let deletedJobTitles = document.getElementById('deleted_job_titles').value;
        document.getElementById('deleted_job_titles').value = deletedJobTitles ? deletedJobTitles + ',' + jobTitleId : jobTitleId;
    }

    // Добавление строки с выпадающим списком для подразделений
    function addDepartmentRow() {
        const departmentRow = `
            <li style="padding: 5px; margin-bottom: 1px;">
                <select name="departments" style="width: 100%;">
                    {% for department in departments %}
                        <option value="{{ department.id }}">{{ department.title }}</option>
                    {% endfor %}
                </select>
            </li>
        `;
        document.getElementById('lightning-departments-list').insertAdjacentHTML('beforeend', departmentRow);
    }

    // Функция для удаления строки подразделение и добавления её ID в скрытое поле
    function removeDepartmentRow(button) {
        const row = button.closest('tr');
        const departmentId = row.getAttribute('data-department-id');  // Получаем ID подразделения из атрибута data-department-id
        row.remove();

        // Добавляем ID удаленной должности в скрытое поле
        let deletedDepartments = document.getElementById('deleted_departments').value;
        document.getElementById('deleted_departments').value = deletedDepartments ? deletedDepartments + ',' + departmentId : departmentId;
    }

</script>

<script>
    // Функция для показа нужной вкладки и управления видимостью сайдбара вопросов
    function showTab(tabId) {
        const tabs = document.querySelectorAll('.tab-content');
        const buttons = document.querySelectorAll('.tab-button');

        // Скрыть все табы и убрать класс active у всех кнопок
        tabs.forEach(tab => {
            tab.style.display = (tab.id === tabId) ? 'block' : 'none';
        });

        buttons.forEach(button => {
            button.classList.toggle('active', button.getAttribute('onclick').includes(tabId));
        });

        // Показать сайдбар вопросов только при выборе вкладки "Тестирование"
        const questionSidebar = document.getElementById('question-sidebar');
        if (tabId === 'testing') {
            questionSidebar.classList.remove('hidden');
        } else {
            questionSidebar.classList.add('hidden');
        }
    }

    // Функция добавления нового блока сообщения
    function addMessageBlock() {
        const messageContainer = document.getElementById('messages-container');
        const newMessageBlock = document.createElement('div');
        newMessageBlock.classList.add('message-block');
    
        newMessageBlock.innerHTML = `
            <input type="hidden" name="message_id[]" value="">
            
            <!-- Кнопка удаления сообщения -->
            <button type="button" class="delete-message-button" onclick="removeMessageBlock(this)">&#10060;</button>
    
            <label>Сообщение:</label>
            <textarea name="message_content[]" style="width: 100%; margin-bottom: 10px;"></textarea>
    
            <label>Наименование кнопки в ТГ (ограничение в 25 символов):</label>
            <input type="text" name="button_text[]" maxlength="25" style="width: 100%; margin-bottom: 10px;">
    
            <label>Порядок сообщения:</label>
            <input type="number" name="order[]" style="width: 100px; margin-bottom: 10px;">
    
            <label>Отправлять текст:</label>
            <input type="checkbox" name="send_text[]" value="1">
    
            <label>Отправлять файл:</label>
            <input type="checkbox" name="send_file[]" value="1">
    
            <label>Изображение для сообщения:</label>
            <input type="file" name="image_lightning[]" style="margin-bottom: 10px;">
    
            <label>Файл для сообщения:</label>
            <input type="file" name="file_lightning[]" style="margin-bottom: 20px;">
    
            <hr>
        `;
    
        messageContainer.appendChild(newMessageBlock);
    }
    // Функция удаления блока сообщения
    function removeMessageBlock(button, messageId = null) {
        const messageBlock = button.closest('.message-block');
        messageBlock.remove();
    
        // Если у сообщения есть ID, добавляем его в поле "deleted_messages"
        if (messageId) {
            const deletedMessagesInput = document.getElementById('deleted_messages');
            deletedMessagesInput.value += messageId + ',';
        }
    }   
</script>

<script>
    function addAnswerRow() {
        const table = document.getElementById('answers-table');
        const rowCount = table.rows.length;
    
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="checkbox" name="display_answer[]" value="${rowCount}"></td>
            <td><input type="checkbox" name="is_correct[]" value="${rowCount}"></td>
            <td>
                <input type="text" name="answer_text[]" style="width: 100%;">
                <input type="hidden" name="answer_id[]" value="">
            </td>
            <td><input type="text" name="answer_number[]" style="width: 50px;"></td>
            <td>
                <button type="button" onclick="removeAnswerRow(this)" style="color: red; background: none; border: none; font-size: 16px; cursor: pointer;">&#10060;</button>
            </td>
        `;
        table.appendChild(newRow);
    }
    
    function removeAnswerRow(button) {
        const row = button.closest('tr');
        row.remove();
    }    
</script>

<script>
    // Функция для создания нового вопроса
    function createQuestion() {
        const lightningId = "{{ lightning.id }}";  // Используем ID молнии из контекста
        console.log("Lightning ID в функции createQuestion:", lightningId);
        if (lightningId) {
            window.location.href = `/ru/lightnings/${lightningId}/question/create/`;
        } else {
            alert("Ошибка: Не выбрана молния для создания вопроса.");
        }
    }
</script>

<script>
    console.log("Шаблон Lightning ID:", "{{ lightning.id }}");
</script>

<!-- Стили -->
<style>
    .vertical-divider {
        border-left: 2px solid white;
        min-height: 100%;
        margin-left: 20px;
    }

    .tab-button {
        padding: 10px 20px;
        border: 1px solid #000;
        border-radius: 5px;
        cursor: pointer;
        text-transform: uppercase;
    }

    .tab-button.active {
        background-color: #28a745;
        color: white;
    }

    .send-lightning-button {
        background-color: #28a745;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        text-transform: uppercase;
    }    

    .save-button {
        background-color: #28a745;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        text-transform: uppercase;
    }

    .delete-button {
        background-color: #dc3545;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        text-transform: uppercase;
        text-decoration: none;
    }

    ul {
        list-style: none;
        padding: 0;
    }

    li {
        padding: 5px;
        border: 1px solid #ddd;
        margin-bottom: 1px;
        background-color: #00234b;
        color: white;
        width: 50%;
    }

    .tab-content {
        display: none;
    }

    #main.tab-content {
        display: block;
    }

    .message-block {
        position: relative;
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        background-color: white;
        border-radius: 8px;
    }

    .message-block label {
        color: #00234b;
    }

    .delete-message-button {
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        color: red;
        font-size: 20px;
        cursor: pointer;
    }

    .hidden {
        display: none;
    }
</style>

{% endblock %}